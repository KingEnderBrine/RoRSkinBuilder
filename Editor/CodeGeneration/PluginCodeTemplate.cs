// ------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version: 17.0.0.0
//  
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
// ------------------------------------------------------------------------------
namespace RoRSkinBuilder
{
    using System.Linq;
    using System.Text;
    using System.Collections.Generic;
    using RoRSkinBuilder.Data;
    using UnityEngine.Rendering;
    using System;
    
    /// <summary>
    /// Class to produce the template output
    /// </summary>
    [global::System.CodeDom.Compiler.GeneratedCodeAttribute("Microsoft.VisualStudio.TextTemplating", "17.0.0.0")]
    public partial class PluginCodeTemplate : PluginCodeTemplateBase
    {
        /// <summary>
        /// Create the template output
        /// </summary>
        public override string TransformText()
        {
            this.Write(@"using BepInEx;
using BepInEx.Logging;
using RoR2;
using System;
using System.Collections.Generic;
using System.Reflection;
using System.Linq;
using UnityEngine;
using System.Security.Permissions;
using MonoMod.RuntimeDetour.HookGen;
using RoR2.ContentManagement;
using UnityEngine.AddressableAssets;
using RoR2.Projectile;


#pragma warning disable CS0618 // Type or member is obsolete
[assembly: SecurityPermission(SecurityAction.RequestMinimum, SkipVerification = true)]
#pragma warning restore CS0618 // Type or member is obsolete
namespace ");
            this.Write(this.ToStringHelper.ToStringWithCulture(AssetsInfo.uccModName));
            this.Write("\r\n{\r\n");
 foreach (var dependency in DistinctDependencies) { 
            this.Write("    [BepInDependency(\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(dependency.Key));
            this.Write("\", BepInDependency.DependencyFlags.");
            this.Write(this.ToStringHelper.ToStringWithCulture(Enum.GetName(typeof(DependencyType), dependency.Value)));
            this.Write(")]\r\n");
 } 
            this.Write("    \r\n    [BepInPlugin(\"com.");
            this.Write(this.ToStringHelper.ToStringWithCulture(SkinModInfo.author.StripSpaces()));
            this.Write(".");
            this.Write(this.ToStringHelper.ToStringWithCulture(AssetsInfo.uccModName));
            this.Write("\",\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(SkinModInfo.modName));
            this.Write("\",\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(SkinModInfo.version));
            this.Write("\")]\r\n    public partial class ");
            this.Write(this.ToStringHelper.ToStringWithCulture(AssetsInfo.uccModName));
            this.Write("Plugin : BaseUnityPlugin\r\n    {\r\n        internal static ");
            this.Write(this.ToStringHelper.ToStringWithCulture(AssetsInfo.uccModName));
            this.Write("Plugin Instance { get; private set; }\r\n        internal static ManualLogSource In" +
                    "stanceLogger => Instance?.Logger;\r\n        \r\n        private static AssetBundle " +
                    "assetBundle;\r\n");
 if (AssetsInfo.materialsWithRoRShader.Count != 0) { 
            this.Write("        private static readonly List<Material> materialsWithRoRShader = new List<" +
                    "Material>();\r\n");
 } 
            this.Write("        private void Start()\r\n        {\r\n            Instance = this;\r\n\r\n        " +
                    "    BeforeStart();\r\n\r\n            using (var assetStream = Assembly.GetExecuting" +
                    "Assembly().GetManifestResourceStream(\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(AssetsInfo.uccModName));
            this.Write(".");
            this.Write(this.ToStringHelper.ToStringWithCulture(AssetsInfo.assetBundleName));
            this.Write(@"""))
            {
                assetBundle = AssetBundle.LoadFromStream(assetStream);
            }

            BodyCatalog.availability.CallWhenAvailable(BodyCatalogInit);
            HookEndpointManager.Add(typeof(Language).GetMethod(nameof(Language.LoadStrings)), (Action<Action<Language>, Language>)LanguageLoadStrings);

");
 if (AssetsInfo.materialsWithRoRShader.Count != 0) { 
            this.Write("            ReplaceShaders();\r\n\r\n");
 } 
            this.Write("            AfterStart();\r\n        }\r\n\r\n        partial void BeforeStart();\r\n    " +
                    "    partial void AfterStart();\r\n        static partial void BeforeBodyCatalogIni" +
                    "t();\r\n        static partial void AfterBodyCatalogInit();\r\n\r\n");
 if (AssetsInfo.materialsWithRoRShader.Count != 0) { 
            this.Write("        private static void ReplaceShaders()\r\n        {\r\n");
 foreach (var row in AssetsInfo.materialsWithRoRShader) { 
            this.Write("            LoadMaterialsWithReplacedShader(@\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(row.Key));
            this.Write("\"\r\n");
 foreach (var material in row.Value) { 
            this.Write("                ,@\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(AssetsInfo.materialPaths[material]));
            this.Write("\"");
 } 
            this.Write(");\r\n");
 } 
            this.Write(@"        }

        private static void LoadMaterialsWithReplacedShader(string shaderPath, params string[] materialPaths)
        {
            var shader = Addressables.LoadAssetAsync<Shader>(shaderPath).WaitForCompletion();
            foreach (var materialPath in materialPaths)
            {
                var material = assetBundle.LoadAsset<Material>(materialPath);
                material.shader = shader;
                materialsWithRoRShader.Add(material);
            }
        }
");
 } 
            this.Write("\r\n        private static void LanguageLoadStrings(Action<Language> orig, Language" +
                    " self)\r\n        {\r\n            orig(self);\r\n\r\n");
 var tokensByLanguage = new Dictionary<string, Dictionary<string, string>>();
var defaultTokens = new Dictionary<string, string>();

foreach (var skin in ReorderedSkins) {
    if (skin.nameTokenLocalizations.Count == 0) {
        continue;
    }
    var nameToken = skin.CreateNameToken(SkinModInfo.author);
    defaultTokens[nameToken] = (skin.nameTokenLocalizations.FirstOrDefault(el => el.language.ToLower() == "en") ?? skin.nameTokenLocalizations.First()).value; 
    
    foreach (var localization in skin.nameTokenLocalizations) {
        if (defaultTokens[nameToken] == localization.value) {
            continue;
        }
        var language = localization.language.ToLower();
        if (!tokensByLanguage.TryGetValue(language, out var tokens)) {
            tokensByLanguage[language] = tokens = new Dictionary<string, string>();
        }
        tokens[nameToken] = localization.value;
    } 
} 
 foreach (var row in defaultTokens) { 
            this.Write("            self.SetStringByToken(\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(row.Key));
            this.Write("\", \"");
            this.Write(this.ToStringHelper.ToStringWithCulture(row.Value.Escape()));
            this.Write("\");\r\n");
 } 
 if (tokensByLanguage.Count > 0) { 
            this.Write("\r\n            switch(self.name.ToLower())\r\n            {\r\n");
     foreach (var row in tokensByLanguage) { 
            this.Write("                case \"");
            this.Write(this.ToStringHelper.ToStringWithCulture(row.Key));
            this.Write("\":\r\n");
         foreach (var value in row.Value) { 
            this.Write("                    self.SetStringByToken(\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(value.Key));
            this.Write("\", \"");
            this.Write(this.ToStringHelper.ToStringWithCulture(value.Value.Escape()));
            this.Write("\");\r\n");
         } 
            this.Write("                    break;\r\n");
     } 
            this.Write("            }\r\n");
 } 
            this.Write("        }\r\n\r\n        private static void BodyCatalogInit()\r\n        {\r\n          " +
                    "  BeforeBodyCatalogInit();\r\n\r\n");
 foreach (var skin in ReorderedSkins) { 
            this.Write("            Add");
            this.Write(this.ToStringHelper.ToStringWithCulture(skin.bodyName.ToUpperCamelCase()));
            this.Write(this.ToStringHelper.ToStringWithCulture(skin.name.ToUpperCamelCase()));
            this.Write("Skin();\r\n");
 } 
            this.Write("\r\n            AfterBodyCatalogInit();\r\n        }\r\n");
 foreach (var skin in ReorderedSkins) { 
            this.Write("\r\n        static partial void ");
            this.Write(this.ToStringHelper.ToStringWithCulture(skin.bodyName.ToUpperCamelCase()));
            this.Write(this.ToStringHelper.ToStringWithCulture(skin.name.ToUpperCamelCase()));
            this.Write("SkinAdded(SkinDef skinDef, GameObject bodyPrefab);\r\n\r\n        private static void" +
                    " Add");
            this.Write(this.ToStringHelper.ToStringWithCulture(skin.bodyName.ToUpperCamelCase()));
            this.Write(this.ToStringHelper.ToStringWithCulture(skin.name.ToUpperCamelCase()));
            this.Write("Skin()\r\n        {\r\n");
 if (!string.IsNullOrWhiteSpace(skin.modDependency.value) && skin.modDependency.type == DependencyType.SoftDependency) { 
            this.Write("            if (!BepInEx.Bootstrap.Chainloader.PluginInfos.ContainsKey(\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(skin.modDependency.value));
            this.Write("\"))\r\n            {\r\n                return;\r\n            }\r\n");
 } 
 if (skin.config.generateEnableConfig) { 
            this.Write("            if (!Instance.Config.Bind(\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(skin.name.ToUpperCamelCase()));
            this.Write("\", \"Enabled\", ");
            this.Write(this.ToStringHelper.ToStringWithCulture(skin.config.enableConfigDefaultValue.ToLiteral()));
            this.Write(").Value)\r\n            {\r\n                return;\r\n            }\r\n");
 } 
            this.Write("            var bodyName = \"");
            this.Write(this.ToStringHelper.ToStringWithCulture(skin.bodyName));
            this.Write("\";\r\n            var skinName = \"");
            this.Write(this.ToStringHelper.ToStringWithCulture(skin.name));
            this.Write("\";\r\n            try\r\n            {\r\n                var bodyPrefab = BodyCatalog." +
                    "FindBodyPrefab(bodyName);\r\n                if (!bodyPrefab)\r\n                {\r\n" +
                    "                    InstanceLogger.LogWarning($\"Failed to add \\\"{skinName}\\\" ski" +
                    "n because \\\"{bodyName}\\\" doesn\'t exist\");\r\n                    return;\r\n        " +
                    "        }\r\n\r\n                var modelLocator = bodyPrefab.GetComponent<ModelLoc" +
                    "ator>();\r\n                if (!modelLocator)\r\n                {\r\n               " +
                    "     InstanceLogger.LogWarning($\"Failed to add \\\"{skinName}\\\" skin to \\\"{bodyNam" +
                    "e}\\\" because it doesn\'t have \\\"ModelLocator\\\" component\");\r\n                    " +
                    "return;\r\n                }\r\n\r\n                var mdl = modelLocator.modelTransf" +
                    "orm.gameObject;\r\n                var skinController = mdl ? mdl.GetComponent<Mod" +
                    "elSkinController>() : null;\r\n                if (!skinController)\r\n             " +
                    "   {\r\n                    InstanceLogger.LogWarning($\"Failed to add \\\"{skinName}" +
                    "\\\" skin to \\\"{bodyName}\\\" because it doesn\'t have \\\"ModelSkinController\\\" compon" +
                    "ent\");\r\n                    return;\r\n                }\r\n\r\n                var re" +
                    "nderers = mdl.GetComponentsInChildren<Renderer>(true);\r\n                var ligh" +
                    "ts = mdl.GetComponentsInChildren<Light>(true);\r\n\r\n                var skin = Scr" +
                    "iptableObject.CreateInstance<SkinDef>();\r\n                var skinParams = Scrip" +
                    "tableObject.CreateInstance<SkinDefParams>();\r\n                skin.skinDefParams" +
                    " = skinParams;\r\n\r\n                TryCatchThrow(\"Icon\", () =>\r\n                {" +
                    "\r\n");
 if (!skin.icon.createFromColors) {
        if (skin.icon.sprite) { 
            this.Write("                    skin.icon = assetBundle.LoadAsset<Sprite>(@\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(AssetsInfo.iconPaths[skin.icon.sprite]));
            this.Write("\");\r\n");
      } else { 
            this.Write("                    skin.icon = null;\r\n");
      } 
    } else { 
            this.Write("                    skin.icon = assetBundle.LoadAsset<Sprite>(@\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(AssetsInfo.iconFromColorPaths[skin.icon.colors]));
            this.Write("\");\r\n");
 } 
            this.Write("                });\r\n                skin.name = skinName;\r\n                skin." +
                    "nameToken = \"");
            this.Write(this.ToStringHelper.ToStringWithCulture(skin.CreateNameToken(SkinModInfo.author)));
            this.Write("\";\r\n                skin.rootObject = mdl;\r\n                TryCatchThrow(\"Base S" +
                    "kins\", () =>\r\n                {\r\n");
 if (skin.baseSkins.Count == 0) { 
            this.Write("                    skin.baseSkins = Array.Empty<SkinDef>();\r\n");
 } else { 
            this.Write("                    skin.baseSkins = new SkinDef[] \r\n                    { \r\n");
 for (var i = 0; i < skin.baseSkins.Count; i++) {
    var reference = skin.baseSkins[i];
    if (reference.accessType == AccessType.ByIndex) { 
            this.Write("                        ThrowIfOutOfBounds(");
            this.Write(this.ToStringHelper.ToStringWithCulture(i));
            this.Write(", \"Index ");
            this.Write(this.ToStringHelper.ToStringWithCulture(reference.index));
            this.Write(" is out of bounds of skins array\", skinController.skins, ");
            this.Write(this.ToStringHelper.ToStringWithCulture(reference.index));
            this.Write("),\r\n");
 } else { 
            this.Write("                        ThrowIfNull(");
            this.Write(this.ToStringHelper.ToStringWithCulture(i));
            this.Write(", \"There is no skin with the name \\\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(reference.name));
            this.Write("\\\"\", skinController.skins.FirstOrDefault(s => s.Name == \"");
            this.Write(this.ToStringHelper.ToStringWithCulture(reference.name));
            this.Write("\")),\r\n");
 } 
} 
            this.Write("                    };\r\n");
 } 
            this.Write("                });\r\n                TryCatchThrow(\"Unlockable Name\", () =>\r\n    " +
                    "            {\r\n");
 if (string.IsNullOrWhiteSpace(skin.unlockableName)) { 
            this.Write("                    skin.unlockableDef = null;\r\n");
 } else { 
            this.Write("                    skin.unlockableDef = ContentManager.unlockableDefs.FirstOrDef" +
                    "ault(def => def.cachedName == \"");
            this.Write(this.ToStringHelper.ToStringWithCulture(skin.unlockableName));
            this.Write("\");\r\n");
 } 
            this.Write("                });\r\n                TryCatchThrow(\"Game Object Activations\", () " +
                    "=>\r\n                {\r\n");
 if (skin.gameObjectActivations.Count == 0) { 
            this.Write("                    skinParams.gameObjectActivations = Array.Empty<SkinDefParams." +
                    "GameObjectActivation>();\r\n");
 } else { 
            this.Write("                    skinParams.gameObjectActivations = new SkinDefParams.GameObje" +
                    "ctActivation[]\r\n                    {\r\n");
 for (var i = 0; i < skin.gameObjectActivations.Count; i++) {
    var activation = skin.gameObjectActivations[i]; 
            this.Write("                        new SkinDefParams.GameObjectActivation\r\n                 " +
                    "       {\r\n");
 if (activation.accessType == GameObjectActivationAccessType.ByRendererName) { 
            this.Write("                            gameObject = ThrowIfNull(");
            this.Write(this.ToStringHelper.ToStringWithCulture(i));
            this.Write(", \"There is no renderer with the name \\\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(activation.rendererName));
            this.Write("\\\"\", renderers.FirstOrDefault(r => r.name == \"");
            this.Write(this.ToStringHelper.ToStringWithCulture(activation.rendererName));
            this.Write("\")).gameObject,\r\n");
 } else if (activation.accessType == GameObjectActivationAccessType.ByPath) { 
            this.Write("                            gameObject = ThrowIfNull(");
            this.Write(this.ToStringHelper.ToStringWithCulture(i));
            this.Write(", \"There is no renderer at path \\\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(activation.path));
            this.Write("\\\"\", mdl.transform.Find(\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(activation.path));
            this.Write("\")).gameObject,\r\n");
 } 
 if (activation.spawnPrefabOnModelObject) { 
            this.Write("                            shouldActivate = false,\r\n                            " +
                    "spawnPrefabOnModelObject = true,\r\n                            localPosition = ");
            this.Write(this.ToStringHelper.ToStringWithCulture(activation.localPosition.ToNewString()));
            this.Write(",\r\n                            localRotation = ");
            this.Write(this.ToStringHelper.ToStringWithCulture(activation.localRotation.ToNewString()));
            this.Write(",\r\n                            localScale = ");
            this.Write(this.ToStringHelper.ToStringWithCulture(activation.localScale.ToNewString()));
            this.Write(",\r\n");
      if (activation.useAddressablesKey) { 
            this.Write("                            prefab = Addressables.LoadAssetAsync<GameObject>(@\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(activation.prefabKey));
            this.Write("\").WaitForCompletion()\r\n");
      } else { 
            this.Write("                            prefab = assetBundle.LoadAsset<GameObject>(@\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(AssetsInfo.uniqueGameObjectActivations[activation.prefab]));
            this.Write("\")\r\n");
      } 
 } else { 
            this.Write("                            shouldActivate = ");
            this.Write(this.ToStringHelper.ToStringWithCulture(activation.shouldActivate.ToLiteral()));
            this.Write(",\r\n                            spawnPrefabOnModelObject = false,\r\n");
 } 
            this.Write("                        },\r\n");
 } 
            this.Write("                    };\r\n");
 } 
            this.Write("                });\r\n                TryCatchThrow(\"Renderer Infos\", () =>\r\n     " +
                    "           {\r\n");
 if (skin.rendererInfos.Count == 0) { 
            this.Write("                    skinParams.rendererInfos = Array.Empty<CharacterModel.Rendere" +
                    "rInfo>();\r\n");
 } else { 
            this.Write("                    skinParams.rendererInfos = new CharacterModel.RendererInfo[]\r" +
                    "\n                    {\r\n");
 for (var i = 0; i < skin.rendererInfos.Count; i++) {
    var rendererInfo = skin.rendererInfos[i]; 
            this.Write("                        new CharacterModel.RendererInfo\r\n                        " +
                    "{\r\n");
 if (rendererInfo.defaultMaterial == null) { 
            this.Write("                            defaultMaterial = null,\r\n");
 } else { 
            this.Write("                            defaultMaterial = assetBundle.LoadAsset<Material>(@\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(AssetsInfo.materialPaths[rendererInfo.defaultMaterial]));
            this.Write("\"),\r\n");
 } 
            this.Write("                            defaultShadowCastingMode = UnityEngine.Rendering.Shad" +
                    "owCastingMode.");
            this.Write(this.ToStringHelper.ToStringWithCulture(Enum.GetName(typeof(ShadowCastingMode), rendererInfo.defaultShadowCastingMode)));
            this.Write(",\r\n                            ignoreOverlays = ");
            this.Write(this.ToStringHelper.ToStringWithCulture(rendererInfo.ignoreOverlays.ToLiteral()));
            this.Write(",\r\n");
 if (rendererInfo.rendererReference.accessType == ComponentAccessType.ByName) { 
            this.Write("                            renderer = ThrowIfNull(");
            this.Write(this.ToStringHelper.ToStringWithCulture(i));
            this.Write(", \"There is no renderer with the name \\\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(rendererInfo.rendererReference.name));
            this.Write("\\\"\", renderers.FirstOrDefault(r => r.name == \"");
            this.Write(this.ToStringHelper.ToStringWithCulture(rendererInfo.rendererReference.name));
            this.Write("\")),\r\n");
 } else if (rendererInfo.rendererReference.accessType == ComponentAccessType.ByPath) { 
            this.Write("                            renderer = ThrowIfNull(");
            this.Write(this.ToStringHelper.ToStringWithCulture(i));
            this.Write(", \"There is no renderer at path \\\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(rendererInfo.rendererReference.path));
            this.Write("\\\"\", mdl.transform.Find(\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(rendererInfo.rendererReference.path));
            this.Write("\")).GetComponent<Renderer>(),\r\n");
 } 
            this.Write("                        },\r\n");
 } 
            this.Write("                    };\r\n");
 } 
            this.Write("                });\r\n                TryCatchThrow(\"Mesh Replacements\", () =>\r\n  " +
                    "              {\r\n");
 if (skin.meshReplacements.Count == 0) { 
            this.Write("                    skinParams.meshReplacements = Array.Empty<SkinDefParams.MeshR" +
                    "eplacement>();\r\n");
 } else { 
            this.Write("                    skinParams.meshReplacements = new SkinDefParams.MeshReplaceme" +
                    "nt[]\r\n                    {\r\n");
 for (var i = 0; i < skin.meshReplacements.Count; i++) {
    var replacement = skin.meshReplacements[i]; 
            this.Write("                        new SkinDefParams.MeshReplacement\r\n                      " +
                    "  {\r\n");
 if (replacement.mesh == null) { 
            this.Write("                            mesh = null,\r\n");
 } else { 
            this.Write("                            mesh = assetBundle.LoadAsset<Mesh>(@\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(AssetsInfo.meshPaths[replacement.mesh]));
            this.Write("\"),\r\n");
 } 
if (replacement.rendererReference.accessType == ComponentAccessType.ByName) { 
            this.Write("                            renderer = ThrowIfNull(");
            this.Write(this.ToStringHelper.ToStringWithCulture(i));
            this.Write(", \"There is no renderer with the name \\\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(replacement.rendererReference.name));
            this.Write("\\\"\", renderers.FirstOrDefault(r => r.name == \"");
            this.Write(this.ToStringHelper.ToStringWithCulture(replacement.rendererReference.name));
            this.Write("\")),\r\n");
 } else if (replacement.rendererReference.accessType == ComponentAccessType.ByPath) { 
            this.Write("                            renderer = ThrowIfNull(");
            this.Write(this.ToStringHelper.ToStringWithCulture(i));
            this.Write(", \"There is no renderer at path \\\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(replacement.rendererReference.path));
            this.Write("\\\"\", mdl.transform.Find(\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(replacement.rendererReference.path));
            this.Write("\")).GetComponent<Renderer>(),\r\n");
 } 
            this.Write("                        },\r\n");
 } 
            this.Write("                    };\r\n");
 } 
            this.Write("                });\r\n                TryCatchThrow(\"Light Infos\", () =>\r\n        " +
                    "        {\r\n");
 if (skin.meshReplacements.Count == 0) { 
            this.Write("                    skinParams.lightReplacements = Array.Empty<CharacterModel.Lig" +
                    "htInfo>();\r\n");
 } else { 
            this.Write("                    skinParams.lightReplacements = new CharacterModel.LightInfo[]" +
                    "\r\n                    {\r\n");
 for (var i = 0; i < skin.lightReplacements.Count; i++) {
    var replacement = skin.lightReplacements[i]; 
            this.Write("                        new CharacterModel.LightInfo\r\n                        {\r\n" +
                    "                            defaultColor = ");
            this.Write(this.ToStringHelper.ToStringWithCulture(replacement.defaultColor.ToNewString()));
            this.Write(",\r\n");
 if (replacement.lightReference.accessType == ComponentAccessType.ByName) { 
            this.Write("                            light = ThrowIfNull(");
            this.Write(this.ToStringHelper.ToStringWithCulture(i));
            this.Write(", \"There is no light with the name \\\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(replacement.lightReference.name));
            this.Write("\\\"\", lights.FirstOrDefault(l => l.name == \"");
            this.Write(this.ToStringHelper.ToStringWithCulture(replacement.lightReference.name));
            this.Write("\")),\r\n");
 } else if (replacement.lightReference.accessType == ComponentAccessType.ByPath) { 
            this.Write("                            light = ThrowIfNull(");
            this.Write(this.ToStringHelper.ToStringWithCulture(i));
            this.Write(", \"There is no light at path \\\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(replacement.lightReference.path));
            this.Write("\\\"\", mdl.transform.Find(\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(replacement.lightReference.path));
            this.Write("\")).GetComponent<Light>(),\r\n");
 } 
            this.Write("                        },\r\n");
 } 
            this.Write("                    };\r\n");
 } 
            this.Write("                });\r\n                TryCatchThrow(\"Minion Skin Replacements\", ()" +
                    " =>\r\n                {\r\n");
 if (skin.minionSkinReplacements.Count == 0) { 
            this.Write("                    skinParams.minionSkinReplacements = Array.Empty<SkinDefParams" +
                    ".MinionSkinReplacement>();\r\n");
 } else { 
            this.Write("                    skinParams.minionSkinReplacements = new SkinDefParams.MinionS" +
                    "kinReplacement[]\r\n                    {\r\n");
 for (var i = 0; i < skin.minionSkinReplacements.Count; i++) {
    var replacement = skin.minionSkinReplacements[i];
    if (!replacement.findSkinByReference && replacement.skin == null) {
        continue;
    } 
            this.Write("                        new SkinDefParams.MinionSkinReplacement\r\n                " +
                    "        {\r\n                            minionBodyPrefab = BodyCatalog.FindBodyPr" +
                    "efab(@\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(replacement.bodyName));
            this.Write("\"),\r\n");
 if (replacement.findSkinByReference) { 
    if (replacement.reference.accessType == AccessType.ByIndex) { 
            this.Write("                            minionSkin = ThrowIfOutOfBounds(");
            this.Write(this.ToStringHelper.ToStringWithCulture(i));
            this.Write(", \"Index ");
            this.Write(this.ToStringHelper.ToStringWithCulture(replacement.reference.index));
            this.Write(" is out of bounds of skins array for body \\\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(replacement.bodyName));
            this.Write("\\\"\", SkinCatalog.FindSkinsForBody(ThrowIfEquals(");
            this.Write(this.ToStringHelper.ToStringWithCulture(i));
            this.Write(", \"Body \\\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(replacement.bodyName));
            this.Write("\\\" doesn\'t exist\", BodyCatalog.FindBodyIndex(@\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(replacement.bodyName));
            this.Write("\"), BodyIndex.None)), ");
            this.Write(this.ToStringHelper.ToStringWithCulture(replacement.reference.index));
            this.Write("),\r\n");
 } else { 
            this.Write("                            minionSkin = ThrowIfNull(");
            this.Write(this.ToStringHelper.ToStringWithCulture(i));
            this.Write(", \"There is no skin with the name \\\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(replacement.reference.name));
            this.Write("\\\" for body \\\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(replacement.bodyName));
            this.Write("\\\"\", SkinCatalog.FindSkinsForBody(ThrowIfEquals(");
            this.Write(this.ToStringHelper.ToStringWithCulture(i));
            this.Write(", \"Body \\\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(replacement.bodyName));
            this.Write("\\\" doesn\'t exist\", BodyCatalog.FindBodyIndex(@\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(replacement.bodyName));
            this.Write("\"), BodyIndex.None)).FirstOrDefault(s => s.name == @\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(replacement.reference.name));
            this.Write("\")),\r\n    ");
 }
} else { 
            this.Write("                            minionSkin = ThrowIfNull(");
            this.Write(this.ToStringHelper.ToStringWithCulture(i));
            this.Write(", \"There is no skin with the name \\\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(replacement.skin.name));
            this.Write("\\\" for body \\\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(replacement.bodyName));
            this.Write("\\\"\", SkinCatalog.FindSkinsForBody(ThrowIfEquals(");
            this.Write(this.ToStringHelper.ToStringWithCulture(i));
            this.Write(", \"Body \\\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(replacement.bodyName));
            this.Write("\\\" doesn\'t exist\", BodyCatalog.FindBodyIndex(@\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(replacement.bodyName));
            this.Write("\"), BodyIndex.None)).FirstOrDefault(s => s.name == @\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(replacement.skin.name));
            this.Write("\")),\r\n");
 } 
            this.Write("                        },\r\n");
 } 
            this.Write("                    };\r\n");
 } 
            this.Write("                });\r\n                TryCatchThrow(\"Projectile Ghost Replacements" +
                    "\", () =>\r\n                {\r\n");
 foreach (var path in AssetsInfo.uniqueProjectileGhostsBySkin[skin]) { 
            this.Write("                    TryAddComponent<ProjectileGhostController>(assetBundle.LoadAs" +
                    "set<GameObject>(@\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(path));
            this.Write("\"));\r\n");
 } 
 if (skin.projectileGhostReplacements.Count == 0) { 
            this.Write("                    skinParams.projectileGhostReplacements = Array.Empty<SkinDefP" +
                    "arams.ProjectileGhostReplacement>();\r\n");
 } else { 
            this.Write("                    skinParams.projectileGhostReplacements = new SkinDefParams.Pr" +
                    "ojectileGhostReplacement[]\r\n                    {\r\n");
 foreach (var replacement in skin.projectileGhostReplacements) { 
            this.Write("                        new SkinDefParams.ProjectileGhostReplacement\r\n           " +
                    "             {\r\n                            projectilePrefab = Addressables.Load" +
                    "AssetAsync<GameObject>(@\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(replacement.projectilePath));
            this.Write("\").WaitForCompletion(),\r\n");
 if (replacement.useAddressablesPath) { 
            this.Write("                            projectileGhostReplacementPrefab = Addressables.LoadA" +
                    "ssetAsync<GameObject>(@\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(replacement.projectileGhostPath));
            this.Write("\").WaitForCompletion(),\r\n");
 } else { 
            this.Write("                            projectileGhostReplacementPrefab = assetBundle.LoadAs" +
                    "set<GameObject>(@\"");
            this.Write(this.ToStringHelper.ToStringWithCulture(AssetsInfo.uniqueProjectileGhosts[replacement.projectileGhost]));
            this.Write("\"),\r\n");
 } 
            this.Write("                        },\r\n");
 } 
            this.Write("                    };\r\n");
 } 
            this.Write("                });\r\n\r\n                Array.Resize(ref skinController.skins, ski" +
                    "nController.skins.Length + 1);\r\n                skinController.skins[skinControl" +
                    "ler.skins.Length - 1] = skin;\r\n\r\n                ");
            this.Write(this.ToStringHelper.ToStringWithCulture(skin.bodyName.ToUpperCamelCase()));
            this.Write(this.ToStringHelper.ToStringWithCulture(skin.name.ToUpperCamelCase()));
            this.Write(@"SkinAdded(skin, bodyPrefab);
            }
            catch (FieldException e)
            {
                if (e.InnerException is ElementException ie)
                {
					InstanceLogger.LogWarning($""Failed to add \""{skinName}\"" skin to \""{bodyName}\"""");
					InstanceLogger.LogWarning($""Field causing issue: {e.Message}, element: {ie.Index}"");
					InstanceLogger.LogWarning(ie.Message);
					InstanceLogger.LogError(e.InnerException);
                }
                else
                {
					InstanceLogger.LogWarning($""Failed to add \""{skinName}\"" skin to \""{bodyName}\"""");
					InstanceLogger.LogWarning($""Field causing issue: {e.Message}"");
					InstanceLogger.LogError(e.InnerException);
                }
            }
            catch (Exception e)
            {
                InstanceLogger.LogWarning($""Failed to add \""{skinName}\"" skin to \""{bodyName}\"""");
                InstanceLogger.LogError(e);
            }
        }
");
 } 
            this.Write("\r\n        private static T ThrowIfEquals<T>(int index, string message, T value, T" +
                    " expected) where T: Enum\r\n        {\r\n            if (value.Equals(expected))\r\n  " +
                    "          {\r\n                throw new ElementException(index, message);\r\n      " +
                    "      }\r\n\r\n            return value;\r\n        }\r\n        \r\n        private stati" +
                    "c T ThrowIfOutOfBounds<T>(int index, string message, T[] array, int elementIndex" +
                    ") where T: class\r\n        {\r\n            if (array is null || array.Length <= el" +
                    "ementIndex)\r\n            {\r\n                throw new ElementException(index, me" +
                    "ssage);\r\n            }\r\n\r\n            return array[elementIndex];\r\n        }\r\n\r\n" +
                    "        private static T ThrowIfNull<T>(int index, string message, T value) wher" +
                    "e T: class\r\n        {\r\n            if (value is null)\r\n            {\r\n          " +
                    "      throw new ElementException(index, message);\r\n            }\r\n\r\n            " +
                    "return value;\r\n        }\r\n\r\n        private static void TryCatchThrow(string mes" +
                    "sage, Action action)\r\n        {\r\n            try\r\n            {\r\n               " +
                    " action?.Invoke();\r\n            }\r\n            catch (Exception e)\r\n            " +
                    "{\r\n                throw new FieldException(message, e);\r\n            }\r\n       " +
                    " }\r\n        \r\n        private static void TryAddComponent<T>(GameObject obj) whe" +
                    "re T : Component\r\n        {\r\n            if (obj && !obj.GetComponent<T>())\r\n   " +
                    "         {\r\n                obj.AddComponent<T>();\r\n            }\r\n        }\r\n\r\n" +
                    "        private class FieldException : Exception\r\n        {\r\n            public " +
                    "FieldException(string message, Exception innerException) : base(message, innerEx" +
                    "ception) { }\r\n        }\r\n\r\n        private class ElementException : Exception\r\n " +
                    "       {\r\n            public int Index { get; }\r\n            public ElementExcep" +
                    "tion(int index, string message) : base(message)\r\n            {\r\n                " +
                    "Index = index;\r\n            }\r\n        }\r\n    }\r\n}");
            return this.GenerationEnvironment.ToString();
        }
    }
}
